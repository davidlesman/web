<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Planner</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            background: #1a1a1a;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 6px;
        }

        .header {
            background: #161b22;
            padding: 20px;
            border-bottom: 1px solid #30363d;
        }

        .header h1 {
            color: #58a6ff;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .header h1::before {
            content: ">>> ";
            color: #7c3aed;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
        }

        .date-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .date-btn:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        .current-date {
            color: #7c3aed;
            font-weight: 500;
            flex: 1;
            text-align: center;
        }

        .content {
            padding: 20px;
        }

        /* Goals & Schedule sections */
        .goals-section,
        .schedule-section {
            border: 1px solid #30363d;
            border-radius: 4px;
        }

        .goals-section {
            margin-bottom: 30px;
        }

        .goals-header,
        .schedule-header {
            background: #161b22;
            padding: 12px 16px;
            border-bottom: 1px solid #30363d;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .goals-header {
            color: #ffa657;
        }

        .goals-header::before {
            content: "[GOALS] ";
            color: #f85149;
        }

        .schedule-header {
            color: #58a6ff;
        }

        .schedule-header::before {
            content: "[SCHEDULE] ";
            color: #f85149;
        }

        .goals-input {
            width: 100%;
            padding: 16px;
            border: none;
            background: #0d1117;
            color: #c9d1d9;
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 120px;
            outline: none;
        }

        .goals-input::placeholder {
            color: #6e7681;
        }

        .time-slots {
            background: #0d1117;
            min-height: 600px;
            position: relative;
        }

        .time-slot {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #21262d;
            cursor: grab;
            transition: background-color .15s ease;
            user-select: none;
            font-size: 0.85rem;
        }

        .time-slot:last-child {
            border-bottom: none;
        }

        .time-slot:hover {
            background: #161b22;
        }

        .time-slot.dragging {
            opacity: .6;
            cursor: grabbing;
            background: #1f2937;
        }

        .time-slot.break {
            opacity: .6;
            cursor: default;
            font-style: italic;
        }

        .time-display {
            color: #7c3aed;
            font-weight: 500;
            min-width: 140px;
            margin-right: 20px;
            cursor: pointer;
        }

        .time-display::before {
            content: "@ ";
            color: #6e7681;
        }

        .time-display:hover {
            color: #a855f7;
        }

        .activity {
            flex: 1;
            color: #c9d1d9;
        }

        .activity::before {
            content: "â–¶ ";
            color: #58a6ff;
            margin-right: 8px;
        }

        .duration-control {
            color: #ffa657;
            font-size: 0.75rem;
            margin-left: 10px;
            cursor: pointer;
            min-width: 60px;
            text-align: right;
        }

        .duration-control:hover {
            color: #ffb366;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: 1px solid #30363d;
            border-radius: 4px;
            background: #21262d;
            color: #f0f6fc;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        .btn.primary {
            background: #238636;
            border-color: #2ea043;
            color: #fff;
        }

        .btn.primary:hover {
            background: #2ea043;
        }

        .btn.secondary {
            background: #da3633;
            border-color: #f85149;
            color: #fff;
        }

        .btn.secondary:hover {
            background: #f85149;
        }

        .btn.tertiary {
            background: #8b5cf6;
            border-color: #a855f7;
            color: #fff;
        }

        .btn.tertiary:hover {
            background: #a855f7;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background: #1f2937;
            color: #10b981;
            border: 1px solid #065f46;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.85rem;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all .3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification::before {
            content: "[OK] ";
            color: #059669;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #161b22;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        ::selection {
            background: #58a6ff;
            color: #0d1117;
        }

        .header h1::after {
            content: "_";
            animation: blink 1s infinite;
            color: #58a6ff;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        @media(max-width:768px) {
            .container {
                margin: 10px;
            }

            .header,
            .content {
                padding: 15px;
            }

            .time-slot {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .time-display {
                min-width: auto;
                margin-right: 0;
            }

            .date-selector {
                flex-direction: column;
                gap: 10px;
            }

            .current-date {
                text-align: left;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>daily_planner.sh</h1>
            <div class="date-selector">
                <button class="date-btn" onclick="changeDate(-1)">
                    < prev</button>
                        <div id="currentDate" class="current-date"></div>
                        <button class="date-btn" onclick="changeDate(1)">next ></button>
            </div>
        </div>
        <div class="content">
            <div class="goals-section">
                <div class="goals-header">daily_goals</div>
                <textarea id="dailyGoals" class="goals-input" placeholder="# Enter your goals for today..."></textarea>
            </div>
            <div class="schedule-section">
                <div class="schedule-header">time_blocks</div>
                <div id="timeSlots" class="time-slots"></div>
            </div>
            <div class="controls">
                <button class="btn primary" onclick="saveDay()">:w save</button>
                <button class="btn secondary" onclick="resetToDefault()">:q! reset</button>
                <button class="btn tertiary" onclick="exportData()">:e export</button>
                <button class="btn" onclick="takeScreenshot()">:p snap</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        /* === constants & state */
        const DAY_START_MINUTES = 6 * 60;
        const DAY_END_MINUTES = 24 * 60;
        let currentDate = new Date();
        let scheduleData = {};
        let draggedElement = null;
        let draggedIndex = -1;
        let shortcutState = 'initial';

        const defaultSchedule = [
            { startTime: "06:00", duration: 60, activity: "Shacharit" },
            { startTime: "07:30", duration: 120, activity: "Work Block" },
            { startTime: "09:00", duration: 90, activity: "Exercise/Gym" },
            { startTime: "12:00", duration: 240, activity: "Deep Work" },
            { startTime: "18:00", duration: 120, activity: "Padel/Exercise" },
            { startTime: "20:00", duration: 60, activity: "Bible" },
            { startTime: "22:00", duration: 60, activity: "Wind Down" }
        ];

        const timeToMinutes = t => { const [h, m] = t.split(":"), hh = +h, mm = +m; return hh * 60 + mm; };
        const minutesToTime = m => `${String(Math.floor(m / 60)).padStart(2, '0')}:${String(m % 60).padStart(2, '0')}`;
        const formatTimeRange = (start, duration) => `${start} - ${minutesToTime(timeToMinutes(start) + duration)}`;
        const formatDate = d => d.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }).replace(/,/g, '');
        const getDateKey = d => d.toISOString().split('T')[0];

        const updateDateDisplay = () => {
            const formatted = formatDate(currentDate);
            document.getElementById('currentDate').textContent = formatted;
        };

        const getCurrentSchedule = () => scheduleData[getDateKey(currentDate)]?.schedule || JSON.parse(JSON.stringify(defaultSchedule));
        const setCurrentSchedule = schedule => { scheduleData[getDateKey(currentDate)] = { ...scheduleData[getDateKey(currentDate)], schedule }; };

        function updateConflictingTimes(schedule) {
            const sorted = [...schedule].sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));
            for (let i = 0; i < sorted.length - 1; i++) {
                const end = timeToMinutes(sorted[i].startTime) + sorted[i].duration;
                const nextStart = timeToMinutes(sorted[i + 1].startTime);
                if (end > nextStart) sorted[i + 1].startTime = minutesToTime(end);
            }
            return sorted;
        }

        function renderSchedule(schedule) {
            const clean = updateConflictingTimes(schedule);
            setCurrentSchedule(clean);
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';

            clean.forEach((slot, index) => {
                const el = document.createElement('div');
                el.className = 'time-slot';
                const range = formatTimeRange(slot.startTime, slot.duration);
                el.innerHTML = `
          <div class="time-display" onclick="editTime(${index})">${range}</div>
          <div class="activity">${slot.activity}</div>
          <div class="duration-control" onclick="editDuration(${index})">${slot.duration}m</div>
        `;
                el.draggable = true;
                el.addEventListener('dragstart', e => { draggedElement = el; draggedIndex = index; el.classList.add('dragging'); });
                el.addEventListener('dragend', () => el.classList.remove('dragging'));
                container.appendChild(el);
            });
            container.ondragover = e => e.preventDefault();
            container.ondrop = handleDrop;
        }

        function editTime(index) {
            const schedule = getCurrentSchedule();
            const slot = schedule[index];
            const newTime = prompt(`New start time for ${slot.activity}`, slot.startTime);
            if (newTime && /^([01]?\d|2[0-3]):[0-5]\d$/.test(newTime)) {
                slot.startTime = newTime;
                renderSchedule(schedule);
                showNotification('time updated');
            }
        }

        function editDuration(index) {
            const schedule = getCurrentSchedule();
            const slot = schedule[index];
            const newDuration = prompt(`New duration in minutes for ${slot.activity}`, slot.duration);
            if (newDuration && !isNaN(newDuration) && newDuration > 0) {
                slot.duration = parseInt(newDuration);
                renderSchedule(schedule);
                showNotification('duration updated');
            }
        }

        function handleDrop(e) {
            if (!draggedElement || draggedIndex < 0) return;
            const schedule = getCurrentSchedule();
            const rect = e.currentTarget.getBoundingClientRect();
            const relY = e.clientY - rect.top;
            const total = DAY_END_MINUTES - DAY_START_MINUTES;
            const minutes = Math.round(relY / (rect.height / total) / 15) * 15 + DAY_START_MINUTES;
            schedule[draggedIndex].startTime = minutesToTime(minutes);
            renderSchedule(schedule);
            showNotification('schedule updated');
            draggedElement = null;
            draggedIndex = -1;
        }

        const saveCurrentDay = () => {
            scheduleData[getDateKey(currentDate)] = {
                goals: document.getElementById('dailyGoals').value,
                schedule: getCurrentSchedule()
            };
        };

        function loadDay() {
            const data = scheduleData[getDateKey(currentDate)];
            document.getElementById('dailyGoals').value = data?.goals || '';
            renderSchedule(data?.schedule || JSON.parse(JSON.stringify(defaultSchedule)));
        }

        const changeDate = delta => { saveCurrentDay(); currentDate.setDate(currentDate.getDate() + delta); updateDateDisplay(); loadDay(); };
        const saveDay = () => { saveCurrentDay(); showNotification('day saved'); };
        const resetToDefault = () => { if (confirm('Reset to default?')) { document.getElementById('dailyGoals').value = ''; renderSchedule(JSON.parse(JSON.stringify(defaultSchedule))); showNotification('schedule reset'); } };
        const exportData = () => {
            const blob = new Blob([JSON.stringify(scheduleData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'planner_data.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('data exported');
        };

        function takeScreenshot() {
            const controls = document.querySelector('.controls');
            const prevDisplay = controls.style.display;
            controls.style.display = 'none';

            // Create a wrapper to clone the header + content
            const container = document.createElement('div');
            const headerClone = document.querySelector('.header').cloneNode(true);
            const contentClone = document.querySelector('.content').cloneNode(true);

            container.appendChild(headerClone);
            container.appendChild(contentClone);
            container.style.backgroundColor = '#1a1a1a';
            container.style.padding = '20px';
            container.style.color = '#c9d1d9';
            container.style.fontFamily = 'JetBrains Mono, monospace';

            document.body.appendChild(container);

            html2canvas(container, {
                backgroundColor: '#1a1a1a'
            }).then(canvas => {
                controls.style.display = prevDisplay;
                document.body.removeChild(container);
                const a = document.createElement('a');
                a.download = `planner_${getDateKey(currentDate)}.png`;
                a.href = canvas.toDataURL('image/png');
                a.click();
                showNotification('screenshot saved');
            }).catch(() => {
                controls.style.display = prevDisplay;
                if (document.body.contains(container)) document.body.removeChild(container);
            });
        }

        function showNotification(message) {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        document.addEventListener('keydown', e => {
            if (shortcutState === 'initial' && e.key === ':') shortcutState = 'colon';
            else if (shortcutState === 'colon') {
                if (e.key === 'w') { saveDay(); shortcutState = 'initial'; }
                else if (e.key === 'e') { exportData(); shortcutState = 'initial'; }
                else if (e.key === 'p') { takeScreenshot(); shortcutState = 'initial'; }
                else if (e.key === 'q') { shortcutState = 'colonq'; }
                else shortcutState = 'initial';
            } else if (shortcutState === 'colonq' && e.key === '!') {
                resetToDefault(); shortcutState = 'initial';
            } else shortcutState = 'initial';
        });

        document.getElementById('dailyGoals').addEventListener('input', saveCurrentDay);
        window.addEventListener('beforeunload', saveCurrentDay);
        updateDateDisplay();
        loadDay();

        /* ----- 1. Create manifest in-memory ----- */
        const manifest = {
            name: "Daily Planner",
            short_name: "Planner",
            start_url: ".",
            display: "standalone",
            theme_color: "#1a1a1a",
            background_color: "#1a1a1a",
        };
        const manifestURL = URL.createObjectURL(
            new Blob([JSON.stringify(manifest)], { type: "application/json" })
        );
        const link = document.createElement("link");
        link.rel = "manifest";
        link.href = manifestURL;
        document.head.appendChild(link);

        /* ----- 2. Create service worker on-the-fly ----- */
        const swCode = `
            self.addEventListener('install', () => self.skipWaiting());
            self.addEventListener('fetch', e => {
                e.respondWith(caches.open('v1').then(async cache => {
                const res = await fetch(e.request).catch(() => cache.match(e.request));
                if (res) cache.put(e.request, res.clone());
                return res;
                }));
            });
        `;
        const swURL = URL.createObjectURL(new Blob([swCode], { type: "text/javascript" }));
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register(swURL).catch(console.error);
        }
    </script>
</body>

</html>